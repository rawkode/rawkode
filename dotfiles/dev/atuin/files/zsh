zgenom load ellie/atuin

# Override this so that the command is
# actually run when we press enter
_atuin_search() {
    emulate -L zsh
    zle -I

    # Switch to cursor mode, then back to application
    echoti rmkx
    # swap stderr and stdout, so that the tui stuff works
    # TODO: not this
    # shellcheck disable=SC2048
    output=$(RUST_LOG=error atuin search $* -i -- $BUFFER 3>&1 1>&2 2>&3)
    echoti smkx

    exitcode=$?

    if [[ -n $output ]]; then
        RBUFFER=""
        LBUFFER=$output
    fi

    if [[ "$exitcode" == "0" ]]; then
        if [[ -n $output ]]; then
            zle accept-line
        fi

        zle redisplay
    else
        zle reset-prompt
    fi
}
