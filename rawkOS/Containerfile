ARG FEDORA_VERSION=40

FROM ghcr.io/ublue-os/akmods:main-${FEDORA_VERSION} as akmods

FROM quay.io/fedora-ostree-desktops/silverblue:${FEDORA_VERSION}

RUN mkdir -p /var/opt

COPY etc /etc/
COPY --from=akmods /rpms/ /tmp/ublue-akmods

RUN rpm-ostree install /tmp/ublue-akmods/ublue-os/ublue-os-akmods*.rpm
RUN rpm-ostree install /tmp/ublue-akmods/kmods/*evdi-*.rpm

RUN rpm --import https://downloads.1password.com/linux/keys/1password.asc
RUN rpm --import http://repo.vivaldi.com/archive/linux_signing_key.pub
RUN rpm --import https://packages.microsoft.com/keys/microsoft.asc

RUN rpm-ostree install 1password 1password-cli code just kmodtool mokutil openssl podman vivaldi

COPY scripts /tmp/scripts
RUN /tmp/scripts/1password.sh
RUN /tmp/scripts/monaspace.sh
RUN /tmp/scripts/vivaldi.sh

COPY usr /usr/

RUN ostree container commit
