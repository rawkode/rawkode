# Parity with Makefile (default target, env, shell)
default: dev

# Use bash to match `SHELL := /bin/bash` in Makefile

set shell := ["/bin/bash", "-cu"]

# Environment defaults (mirrors ${VAR:-default} usage in Makefile)

rawko_runtime_host := env_var_or_default("RAWKO_RUNTIME_HOST", "127.0.0.1")
rawko_runtime_port := env_var_or_default("RAWKO_RUNTIME_PORT", "8788")
public_runtime_url := env_var_or_default("PUBLIC_RUNTIME_URL", "http://127.0.0.1:8788")
web_host := env_var_or_default("WEB_HOST", "127.0.0.1")
web_port := env_var_or_default("WEB_PORT", "4321")

# Default recipe is 'dev' via `default: dev`

dev:
    ./scripts/dev.sh

dev-runtime:
    deno run -A --config runtime/deno.json runtime/src/main.ts \
      --host "{{ rawko_runtime_host }}" \
      --port "{{ rawko_runtime_port }}" \
      --no-stdin --no-prewarm

dev-web:
    cd web && \
      PUBLIC_RUNTIME_URL="{{ public_runtime_url }}" \
      deno task dev -- --host "{{ web_host }}" --port "{{ web_port }}"

check:
    cd runtime && deno task check && deno task test && deno task lint
    cd web && deno task check
